<h2 id="rxjava-2">RxJava 2</h2>

<p>Arrow aims to enhance the user experience when using RxJava. While providing other datatypes that are capable of handling effects, like IO, the style of programming encouraged by the library allows users to generify behavior for any existing abstractions.</p>

<p>One of such abstractions is RxJava, a library focused on providing composable streams that enable reactive programming. Observable streams are created by chaining operators into what are called observable chains.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Observable</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="m">7</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">11</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
  <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">it</span> <span class="p">+</span> <span class="m">1</span> <span class="p">}</span>
  <span class="p">.</span><span class="n">filter</span> <span class="p">{</span> <span class="n">it</span> <span class="p">%</span> <span class="m">2</span> <span class="p">==</span> <span class="m">0</span> <span class="p">}</span>
  <span class="p">.</span><span class="n">scan</span> <span class="p">{</span> <span class="n">acc</span><span class="p">,</span> <span class="n">value</span> <span class="p">-&gt;</span> <span class="n">acc</span> <span class="p">+</span> <span class="n">value</span> <span class="p">}</span>
  <span class="p">.</span><span class="n">toList</span><span class="p">()</span>
  <span class="p">.</span><span class="n">subscribeOn</span><span class="p">(</span><span class="n">Schedulers</span><span class="p">.</span><span class="n">computation</span><span class="p">())</span>
  <span class="p">.</span><span class="n">blockingFirst</span><span class="p">()</span>
<span class="c1">//[8, 20, 24]</span>
</code></pre></div></div>

<h3 id="integration-with-your-existing-observable-chains">Integration with your existing Observable chains</h3>

<p>The largest quality of life improvement when using Observables in Arrow is the introduction of the <a href="/docs/patterns/monadcomprehensions">Monad Comprehension</a>. This library construct allows expressing asynchronous Observable sequences as synchronous code using binding/bind.</p>

<h4 id="arrow-wrapper">Arrow Wrapper</h4>

<p>To wrap any existing Observable in its Arrow Wrapper counterpart you can use the extension function <code class="highlighter-rouge">k()</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">arrow.effects.*</span>
<span class="k">import</span> <span class="nn">io.reactivex.*</span>
<span class="k">import</span> <span class="nn">io.reactivex.subjects.*</span>

<span class="kd">val</span> <span class="py">obs</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">.</span><span class="n">fromArray</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">).</span><span class="n">k</span><span class="p">()</span>
<span class="n">obs</span>
<span class="c1">// ObservableK(observable=io.reactivex.internal.operators.observable.ObservableFromArray@4320b093)</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">flow</span> <span class="p">=</span> <span class="n">Flowable</span><span class="p">.</span><span class="n">fromArray</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">).</span><span class="n">k</span><span class="p">()</span>
<span class="n">flow</span>
<span class="c1">// FlowableK(flowable=io.reactivex.internal.operators.flowable.FlowableFromArray@41cac1f2)</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">subject</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;().</span><span class="n">k</span><span class="p">()</span>
<span class="n">subject</span>
<span class="c1">// ObservableK(observable=io.reactivex.subjects.PublishSubject@7cf29fea)</span>
</code></pre></div></div>

<p>You can return to their regular forms using the function <code class="highlighter-rouge">value()</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">obs</span><span class="p">.</span><span class="n">value</span><span class="p">()</span>
<span class="c1">// io.reactivex.internal.operators.observable.ObservableFromArray@4320b093</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flow</span><span class="p">.</span><span class="n">value</span><span class="p">()</span>
<span class="c1">// io.reactivex.internal.operators.flowable.FlowableFromArray@41cac1f2</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">subject</span><span class="p">.</span><span class="n">value</span><span class="p">()</span>
<span class="c1">// io.reactivex.subjects.PublishSubject@7cf29fea</span>
</code></pre></div></div>

<h3 id="observable-comprehensions">Observable comprehensions</h3>

<p>The library provides instances of <a href="/docs/typeclasses/monaderror"><code class="highlighter-rouge">MonadError</code></a> and <a href="/docs/effects/monaddefer"><code class="highlighter-rouge">MonadDefer</code></a>.</p>

<p><a href="/docs/effects/async"><code class="highlighter-rouge">MonadDefer</code></a> allows you to generify over datatypes that can run asynchronous code. You can use it with <code class="highlighter-rouge">ObservableK</code> and <code class="highlighter-rouge">FlowableK</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="n">getSongUrlAsync</span><span class="p">(</span><span class="n">MS</span><span class="p">:</span> <span class="n">MonadDefer</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;)</span> <span class="p">=</span>
  <span class="n">MS</span> <span class="p">{</span> <span class="n">getSongUrl</span><span class="p">()</span> <span class="p">}</span>

<span class="kd">val</span> <span class="py">songObservable</span><span class="p">:</span> <span class="n">ObservableKOf</span><span class="p">&lt;</span><span class="n">Url</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">getSongUrlAsync</span><span class="p">(</span><span class="n">ObservableK</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">())</span>
<span class="kd">val</span> <span class="py">songFlowable</span><span class="p">:</span> <span class="n">FlowableKOf</span><span class="p">&lt;</span><span class="n">Url</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">getSongUrlAsync</span><span class="p">(</span><span class="n">FlowableK</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">())</span>
</code></pre></div></div>

<p><a href="/docs/typeclasses/monaderror"><code class="highlighter-rouge">MonadError</code></a> can be used to start a <a href="/docs/patterns/monadcomprehensions">Monad Comprehension</a> using the method <code class="highlighter-rouge">bindingCatch</code>, with all its benefits.</p>

<p>Let’s take an example and convert it to a comprehension. We’ll create an observable that loads a song from a remote location, and then reports the current play % every 100 milliseconds until the percentage reaches 100%:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getSongUrlAsync</span><span class="p">()</span>
  <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">songUrl</span> <span class="p">-&gt;</span> <span class="n">MediaPlayer</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">songUrl</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">totalTime</span> <span class="p">=</span> <span class="n">musicPlayer</span><span class="p">.</span><span class="n">getTotaltime</span><span class="p">()</span>
    <span class="n">Observable</span><span class="p">.</span><span class="n">interval</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="n">Milliseconds</span><span class="p">)</span>
      <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span>
        <span class="n">Observable</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">musicPlayer</span><span class="p">.</span><span class="n">getCurrentTime</span><span class="p">()</span> <span class="p">}</span>
          <span class="p">.</span><span class="n">subscribeOn</span><span class="p">(</span><span class="n">AndroidSchedulers</span><span class="p">.</span><span class="n">mainThread</span><span class="p">())</span>
          <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">tick</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">tick</span> <span class="p">/</span> <span class="n">totalTime</span> <span class="p">*</span> <span class="m">100</span><span class="p">).</span><span class="n">toInt</span><span class="p">()</span> <span class="p">}</span>
      <span class="p">}</span>
      <span class="p">.</span><span class="n">takeUntil</span> <span class="p">{</span> <span class="n">percent</span> <span class="p">-&gt;</span> <span class="n">percent</span> <span class="p">&gt;=</span> <span class="m">100</span> <span class="p">}</span>
      <span class="p">.</span><span class="n">observeOn</span><span class="p">(</span><span class="n">Schedulers</span><span class="p">.</span><span class="n">immediate</span><span class="p">())</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>When rewritten using <code class="highlighter-rouge">bindingCatch</code> it becomes:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ObservableK</span><span class="p">.</span><span class="n">monadError</span><span class="p">().</span><span class="n">bindingCatch</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">songUrl</span> <span class="p">=</span> <span class="n">getSongUrlAsync</span><span class="p">().</span><span class="n">bind</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">musicPlayer</span> <span class="p">=</span> <span class="n">MediaPlayer</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">songUrl</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">totalTime</span> <span class="p">=</span> <span class="n">musicPlayer</span><span class="p">.</span><span class="n">getTotaltime</span><span class="p">()</span>

  <span class="kd">val</span> <span class="py">end</span> <span class="p">=</span> <span class="n">PublishSubject</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;()</span>
  <span class="n">Observable</span><span class="p">.</span><span class="n">interval</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="n">Milliseconds</span><span class="p">).</span><span class="n">takeUntil</span><span class="p">(</span><span class="n">end</span><span class="p">).</span><span class="n">bind</span><span class="p">()</span>

  <span class="kd">val</span> <span class="py">tick</span> <span class="p">=</span> <span class="n">bindIn</span><span class="p">(</span><span class="n">UI</span><span class="p">)</span> <span class="p">{</span> <span class="n">musicPlayer</span><span class="p">.</span><span class="n">getCurrentTime</span><span class="p">()</span> <span class="p">}</span>
  <span class="kd">val</span> <span class="py">percent</span> <span class="p">=</span> <span class="p">(</span><span class="n">tick</span> <span class="p">/</span> <span class="n">totalTime</span> <span class="p">*</span> <span class="m">100</span><span class="p">).</span><span class="n">toInt</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="p">&gt;=</span> <span class="m">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">end</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">percent</span>
<span class="p">}.</span><span class="n">fix</span><span class="p">()</span>
</code></pre></div></div>

<p>Note that any unexpected exception, like <code class="highlighter-rouge">AritmeticException</code> when <code class="highlighter-rouge">totalTime</code> is 0, is automatically caught and wrapped inside the observable.</p>

<h3 id="subscription-and-cancellation">Subscription and cancellation</h3>

<p>Observables created with comprehensions like <code class="highlighter-rouge">bindingCatch</code> behave the same way regular observables do, including cancellation by disposing the subscription.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">disposable</span> <span class="p">=</span>
  <span class="n">songObservable</span><span class="p">.</span><span class="n">value</span><span class="p">()</span>
    <span class="p">.</span><span class="n">subscribe</span><span class="p">({</span> <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="s">"Song $it"</span><span class="p">)</span> <span class="p">}</span> <span class="p">,</span> <span class="p">{</span> <span class="n">println</span><span class="p">(</span><span class="s">"Error $it"</span><span class="p">)</span> <span class="p">})</span>

<span class="n">disposable</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
</code></pre></div></div>

<p>Note that <a href="/docs/effects/monaddefer"><code class="highlighter-rouge">MonadDefer</code></a> provides an alternative to <code class="highlighter-rouge">bindingCatch</code> called <code class="highlighter-rouge">bindingCancellable</code> returning a <code class="highlighter-rouge">arrow.Disposable</code>.
Invoking this <code class="highlighter-rouge">Disposable</code> causes an <code class="highlighter-rouge">BindingCancellationException</code> in the chain which needs to be handled by the subscriber, similarly to what <code class="highlighter-rouge">Deferred</code> does.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="err">(</span><span class="py">observable</span><span class="p">,</span> <span class="n">disposable</span><span class="p">)</span> <span class="p">=</span>
  <span class="n">ObservableK</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">().</span><span class="n">bindingCancellable</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">userProfile</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">getUserProfile</span><span class="p">(</span><span class="s">"123"</span><span class="p">)</span> <span class="p">}</span>
    <span class="kd">val</span> <span class="py">friendProfiles</span> <span class="p">=</span> <span class="n">userProfile</span><span class="p">.</span><span class="n">friends</span><span class="p">().</span><span class="n">map</span> <span class="p">{</span> <span class="n">friend</span> <span class="p">-&gt;</span>
        <span class="n">bindAsync</span><span class="p">(</span><span class="n">observableAsync</span><span class="p">)</span> <span class="p">{</span> <span class="n">getProfile</span><span class="p">(</span><span class="n">friend</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">listOf</span><span class="p">(</span><span class="n">userProfile</span><span class="p">)</span> <span class="p">+</span> <span class="n">friendProfiles</span>
  <span class="p">}</span>

<span class="n">observable</span><span class="p">.</span><span class="n">value</span><span class="p">()</span>
  <span class="p">.</span><span class="n">subscribe</span><span class="p">({</span> <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="s">"User $it"</span><span class="p">)</span> <span class="p">}</span> <span class="p">,</span> <span class="p">{</span> <span class="n">println</span><span class="p">(</span><span class="s">"Boom! caused by $it"</span><span class="p">)</span> <span class="p">})</span>

<span class="n">disposable</span><span class="p">()</span>
<span class="c1">// Boom! caused by BindingCancellationException</span>
</code></pre></div></div>

<h2 id="available-instances">Available Instances</h2>

<ul>
  <li><a href="/docs/typeclasses/Applicative">Applicative</a></li>
  <li><a href="/docs/typeclasses/ApplicativeError">ApplicativeError</a></li>
  <li><a href="/docs/typeclasses/Functor">Functor</a></li>
  <li><a href="/docs/typeclasses/Monad">Monad</a></li>
  <li><a href="/docs/typeclasses/MonadError">MonadError</a></li>
  <li><a href="/docs/typeclasses/MonadDefer">MonadDefer</a></li>
  <li><a href="/docs/effects/async">Async</a></li>
  <li><a href="/docs/effects/effect">Effect</a></li>
  <li><a href="/docs/effects/foldable">Foldable</a></li>
  <li><a href="/docs/effects/traverse">Traverse</a></li>
</ul>
