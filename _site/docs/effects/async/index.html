<h2 id="async">Async</h2>

<p>Being able to run code in a different context of execution (i.e. thread) than the current one implies that, even if itâ€™s part of a sequence, the code will have to be asynchronous.
Running asynchronous code always requires a callback after completion on error capable of returning to the current thread.</p>

<p>The same way the typeclass <a href="/docs/typeclasses/monad"><code class="highlighter-rouge">Monad</code></a> represents a sequence of events, and <a href="/docs/typeclasses/monaderror"><code class="highlighter-rouge">MonadError</code></a> a sequence that can fail, the typeclass <code class="highlighter-rouge">Async</code> represents asynchronous code with a callback.
Examples of that can run code asynchronously are typically datatypes that can suspend effects, and delay evaluation.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">arrow.*</span>
<span class="k">import</span> <span class="nn">arrow.core.*</span>
<span class="k">import</span> <span class="nn">arrow.effects.*</span>

<span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">()</span>
  <span class="p">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">Either</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">,</span> <span class="n">Int</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">-&gt;</span>
    <span class="n">callback</span><span class="p">(</span><span class="m">1</span><span class="p">.</span><span class="n">right</span><span class="p">())</span>
  <span class="p">}.</span><span class="n">fix</span><span class="p">().</span><span class="n">attempt</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">()</span>
<span class="c1">// Right(b=1)</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">()</span>
  <span class="p">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">Either</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">,</span> <span class="n">Int</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">-&gt;</span>
    <span class="n">callback</span><span class="p">(</span><span class="n">RuntimeException</span><span class="p">().</span><span class="n">left</span><span class="p">())</span>
  <span class="p">}.</span><span class="n">fix</span><span class="p">().</span><span class="n">attempt</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">()</span>
<span class="c1">// Left(a=java.lang.RuntimeException)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Async</code> includes all combinators present in <a href="/docs/effects/monaddefer/"><code class="highlighter-rouge">MonadDefer</code></a>.</p>

<h3 id="main-combinators">Main Combinators</h3>

<h4 id="async-1">async</h4>

<p>Receives a function returning <code class="highlighter-rouge">Unit</code> with a callback as a parameter.
The function is responsible of calling the callback once it obtains a result.
The callback accepts <code class="highlighter-rouge">Either&lt;Throwable, A&gt;</code> as the return, where the left side of the <a href="/docs/datatypes/either"><code class="highlighter-rouge">Either</code></a> represents an error in the execution and the right side is the completion value of the operation.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">()</span>
  <span class="p">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">Either</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">,</span> <span class="n">Int</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">-&gt;</span>
    <span class="n">userFetcherWithCallback</span><span class="p">(</span><span class="s">"1"</span><span class="p">).</span><span class="n">startAsync</span><span class="p">({</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span> <span class="p">-&gt;</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">left</span><span class="p">())</span>
    <span class="p">},</span> <span class="p">{</span> <span class="n">error</span><span class="p">:</span> <span class="n">Exception</span> <span class="p">-&gt;</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">right</span><span class="p">())</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">()</span>
  <span class="p">.</span><span class="n">async</span> <span class="p">{</span> <span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">Either</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">,</span> <span class="n">Int</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">-&gt;</span>
    <span class="n">userFromDatabaseObservable</span><span class="p">().</span><span class="n">subscribe</span><span class="p">({</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span> <span class="p">-&gt;</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">left</span><span class="p">())</span>
    <span class="p">},</span> <span class="p">{</span> <span class="n">error</span><span class="p">:</span> <span class="n">Exception</span> <span class="p">-&gt;</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">right</span><span class="p">())</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<h4 id="never">never</h4>

<p>Creates an object using <code class="highlighter-rouge">async()</code> whose callback is never called.</p>

<p>Depending on how the datatype is implemented this may cause unexpected errors like awaiting infinitely for a result.</p>

<p>Use with <em>SEVERE CAUTION</em>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">()</span>
  <span class="p">.</span><span class="n">never</span><span class="p">()</span>
  <span class="p">.</span><span class="n">unsafeRunSync</span><span class="p">()</span>
<span class="c1">// ERROR!! The program blocks the current thread forever.</span>
</code></pre></div></div>

<blockquote>
  <p>never() exists to test datatypes that can handle non-termination.
For example, IO has unsafeRunTimed that runs never() safely.</p>
</blockquote>

<h3 id="syntax-available-inside-monad-comprehensions">Syntax available inside Monad Comprehensions</h3>

<p>All the syntax functions are geared towards using <code class="highlighter-rouge">Async</code> inside <a href="/docs/patterns/monadcomprehensions">Monad Comprehension</a>
to create blocks of code to be run asynchronously.</p>

<h4 id="bindingbindasync">binding#bindAsync</h4>

<p>Runs a function parameter in the Async passed as a parameter,
and then awaits for the result before continuing the execution.</p>

<p>Note that there is no automatic error handling or wrapping of exceptions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">monad</span><span class="p">().</span><span class="n">binding</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">a</span> <span class="p">=</span> <span class="n">bindAsync</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">())</span> <span class="p">{</span> <span class="n">fibonacci</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">a</span> <span class="p">+</span> <span class="m">1</span>
<span class="p">}.</span><span class="n">fix</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="bindingbindasyncunsafe">binding#bindAsyncUnsafe</h4>

<p>Runs a function parameter in the Async passed as a parameter,
and then awaits for the result before continuing the execution.</p>

<p>While there is no wrapping of exceptions, the left side of the <a href="/docs/datatypes/either"><code class="highlighter-rouge">Either</code></a> represents an error in the execution.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">monad</span><span class="p">().</span><span class="n">binding</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">a</span> <span class="p">=</span> <span class="n">bindAsync</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">())</span> <span class="p">{</span> <span class="n">fibonacci</span><span class="p">(</span><span class="m">100</span><span class="p">).</span><span class="n">left</span><span class="p">()</span> <span class="p">}</span>
  <span class="n">a</span> <span class="p">+</span> <span class="m">1</span>
<span class="p">}.</span><span class="n">fix</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">monad</span><span class="p">().</span><span class="n">binding</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">a</span> <span class="p">=</span> <span class="n">bindAsync</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">())</span> <span class="p">{</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">"Boom"</span><span class="p">).</span><span class="n">right</span><span class="p">()</span> <span class="p">}</span>
  <span class="n">a</span> <span class="p">+</span> <span class="m">1</span>
<span class="p">}.</span><span class="n">fix</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="laws">Laws</h3>

<p>Arrow provides <a href="/docs/typeclasses/laws#asynclaws"><code class="highlighter-rouge">AsyncLaws</code></a> in the form of test cases for internal verification of lawful instances and third party apps creating their own <code class="highlighter-rouge">Async</code> instances.</p>

<h3 id="data-types">Data Types</h3>

<p>The following data types in Arrow provide instances that adhere to the <code class="highlighter-rouge">Async</code> type class.</p>

<ul>
  <li><a href="/docs/effects/io">IO</a></li>
  <li><a href="/docs/integrations/rx2">ObservableK</a></li>
  <li><a href="/docs/integrations/rx2">FlowableK</a></li>
  <li><a href="/docs/integrations/kotlinxcoroutines/">DeferredK</a></li>
</ul>
