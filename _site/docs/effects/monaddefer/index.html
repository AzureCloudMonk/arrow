<h2 id="monaddefer">MonadDefer</h2>

<p><code class="highlighter-rouge">MonadDefer</code> is a typeclass representing suspension of execution via functions, allowing for asynchronous and lazy computations.</p>

<p><code class="highlighter-rouge">MonadDefer</code> includes all combinators present in <a href="/docs/typeclasses/monaderror"><code class="highlighter-rouge">MonadError</code></a>.</p>

<h3 id="main-combinators">Main Combinators</h3>

<h4 id="invoke">invoke</h4>

<p>Receives a function returning <code class="highlighter-rouge">A</code>. The instance is responsible of evaluating the function lazily.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">().</span><span class="n">invoke</span> <span class="p">{</span> <span class="m">1</span> <span class="p">}</span>
</code></pre></div></div>

<p>As it captures exceptions, <code class="highlighter-rouge">invoke()</code> is the simplest way of wrapping existing synchronous APIs.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="n">getSongUrlAsync</span><span class="p">(</span><span class="n">SC</span><span class="p">:</span> <span class="n">MonadDefer</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;)</span> <span class="p">=</span>
  <span class="n">SC</span> <span class="p">{</span> <span class="n">getSongUrl</span><span class="p">()</span> <span class="p">}</span>

<span class="kd">val</span> <span class="py">songIO</span><span class="p">:</span> <span class="n">IOOf</span><span class="p">&lt;</span><span class="n">Url</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">getSongUrlAsync</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">())</span>
<span class="kd">val</span> <span class="py">songDeferred</span><span class="p">:</span> <span class="n">DeferredKOf</span><span class="p">&lt;</span><span class="n">Url</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">getSongUrlAsync</span><span class="p">(</span><span class="n">DeferredK</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">())</span>
</code></pre></div></div>

<h4 id="defer">defer</h4>

<p>Receives a function returning <code class="highlighter-rouge">Kind&lt;F, A&gt;</code>. The instance is responsible of creating and running the returned datatype lazily.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">().</span><span class="n">defer</span> <span class="p">{</span> <span class="n">IO</span><span class="p">.</span><span class="n">just</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>This can be used to wrap synchronous APIs that already return the expected datatype, forcing them to be run lazily.</p>

<h4 id="lazy">lazy</h4>

<p>Suspends a function returning <code class="highlighter-rouge">Unit</code>.
Useful in cases like <a href="/docs/patterns/monadcomprehensions">Monad Comprehension</a> where youâ€™d want to defer the start of the comprehension until the datatype is run without needing to use suspend.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">SC</span> <span class="p">=</span> <span class="n">IO</span><span class="p">.</span><span class="n">monadDefer</span><span class="p">()</span>

<span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">SC</span><span class="p">.</span><span class="n">binding</span> <span class="p">{</span>
  <span class="n">println</span><span class="p">(</span><span class="s">"Print: now"</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">just</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">bind</span><span class="p">()</span>
  <span class="n">result</span> <span class="p">+</span> <span class="m">1</span>
<span class="p">}</span>

<span class="c1">//Print: now</span>

<span class="kd">val</span> <span class="py">lazyResult</span> <span class="p">=</span> <span class="n">SC</span><span class="p">.</span><span class="n">binding</span> <span class="p">{</span>
  <span class="n">SC</span><span class="p">.</span><span class="n">lazy</span><span class="p">().</span><span class="n">bind</span><span class="p">()</span>
  <span class="n">println</span><span class="p">(</span><span class="s">"Print: lazy"</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">eagerIO</span><span class="p">().</span><span class="n">bind</span><span class="p">()</span>
  <span class="n">result</span> <span class="p">+</span> <span class="m">1</span>
<span class="p">}</span>

<span class="c1">//Nothing here!</span>

<span class="n">lazyResult</span>
  <span class="p">.</span><span class="n">unsafeRunAsync</span> <span class="p">{</span> <span class="p">}</span>

<span class="c1">//Print: lazy</span>
</code></pre></div></div>

<h4 id="deferunsafe">deferUnsafe</h4>

<p>Takes as a parameter a function that returns <code class="highlighter-rouge">Either&lt;Throwable, A&gt;</code>.
The left side of the <a href="/docs/datatypes/either"><code class="highlighter-rouge">Either</code></a> represents an error in the execution.
This function is assumed to never throw any internal exceptions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">()</span>
  <span class="p">.</span><span class="n">deferUnsafe</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">.</span><span class="n">unsafeRunSync</span><span class="p">()</span>
<span class="c1">// ERROR!! The program crashes</span>
</code></pre></div></div>

<blockquote>
  <p>deferUnsafe() exists for performance purposes when throwing can be avoided.</p>
</blockquote>

<h3 id="comprehensions">Comprehensions</h3>

<h4 id="bindindcancellable">bindindCancellable</h4>

<p>It starts a <a href="/docs/patterns/monadcomprehensions">Monad Comprehension</a> that allows for cancellation and suspension in separate threads.</p>

<h4 id="bindindcancellablebinddefer">bindindCancellable#bindDefer</h4>

<p>Binds the function parameter by wrapping the result in <code class="highlighter-rouge">just()</code>.</p>

<p>Exceptions are wrapped in <code class="highlighter-rouge">raiseError()</code>.</p>

<h4 id="bindindcancellablebinddeferin">bindindCancellable#bindDeferIn</h4>

<p>Executes the function parameter in a separate <code class="highlighter-rouge">CoroutineContext</code> and wraps the result in <code class="highlighter-rouge">just()</code>.</p>

<p>Exceptions are wrapped in <code class="highlighter-rouge">raiseError()</code>.</p>

<h4 id="bindindcancellablebinddeferunsafe">bindindCancellable#bindDeferUnsafe</h4>

<p>Binds the function parameter by wrapping the result in <code class="highlighter-rouge">just()</code>.</p>

<p>While there is no wrapping of exceptions, the left side of the <a href="/docs/datatypes/either"><code class="highlighter-rouge">Either</code></a> represents an error in the execution.</p>

<h3 id="laws">Laws</h3>

<p>Arrow provides <a href="/docs/typeclasses/laws#monaddeferlaws"><code class="highlighter-rouge">MonadDeferLaws</code></a> in the form of test cases for internal verification of lawful instances and third party apps creating their own <code class="highlighter-rouge">MonadDefer</code> instances.</p>

<h3 id="data-types">Data Types</h3>

<p>The following data types in Arrow provide instances that adhere to the <code class="highlighter-rouge">MonadDefer</code> type class.</p>

<ul>
  <li><a href="/docs/effects/io">IO</a></li>
  <li><a href="/docs/integrations/rx2">ObservableK</a></li>
  <li><a href="/docs/integrations/rx2">FlowableK</a></li>
  <li><a href="/docs/integrations/kotlinxcoroutines/">DeferredK</a></li>
</ul>
